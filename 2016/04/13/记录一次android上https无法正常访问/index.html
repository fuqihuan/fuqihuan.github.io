<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.19" />

  <title>记录一次android上https无法正常访问 &middot; inorz.net</title>

  
  
  <link rel="stylesheet" href="http://inorz.net/static/pure/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://inorz.net/static/pure/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://inorz.net/static/pure/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://inorz.net/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://inorz.net/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://inorz.net/css/blackburn.css">

  
  <link rel="stylesheet" href="http://inorz.net/static/font-awesome/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="http://inorz.net/static/highlight/styles/monokai-sublime.css">
  <script src="http://inorz.net/static/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://inorz.net/img/favicon.ico" type="image/x-icon" />

  
  

  
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3db042763e07f3ca38ad8111598c5066";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <meta name="baidu-site-verification" content="kEb6ugkyor" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="http://inorz.net/">inorz.net</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://inorz.net/"><i class='fa fa-home fa-fw'></i>主页</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://inorz.net/post/"><i class='fa fa-list fa-fw'></i>文章列表</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://inorz.net/about/"><i class='fa fa-user fa-fw'></i>关于我</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://inorz.net/contact/"><i class='fa fa-phone fa-fw'></i>没想好</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/*" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/*" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://plus.google.com/+*" target="_blank"><i class="fa fa-google-plus-square fa-fw"></i>Google+</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://weibo.com/*" target="_blank"><i class="fa fa-weibo fa-fw"></i>Weibo</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>©2015-2017 ღ fuqihuan</small>
  </div>
  <div class="small-print">
    <small style="color: #191818;">.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>记录一次android上https无法正常访问</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2016-04-13 00:55:48</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://inorz.net/tags/android">android</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://inorz.net/tags/openssl">openssl</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://inorz.net/tags/nginx">nginx</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://inorz.net/tags/sni">sni</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://inorz.net/tags/https">https</a>
    
  </div>
  
  

</div>

  <p>有同鞋反馈过来说，A域名通过Https去访问，完全无法建立连接。用B域名则没有任何问题。于是排除了代码这块的问题。
A域名和B域名，在浏览器上打开，则是完全没问题的。于是在小猜会不会是代码有问题。
然后就开始一系列的排查过程。
期间大神也过来帮忙一起排查。</p>

<p></p>

<h2 id="排查过程">排查过程</h2>

<ol>
<li><p>在自己的Mac下用了以下命令去测试连接A.test.domain.com，发现请求异常。无法建议连接。</p>

<pre><code class="language-bash">openssl s_client -connect A.test.domain.com:443
openssl s_client -connect A.test.domain.com:443 -tls1
openssl s_client -connect A.test.domain.com:443 -ssl3
openssl s_client -connect A.test.domain.com:443 -debug
...
# 返回都是
CONNECTED(00000003)
write:errno=54
</code></pre></li>

<li><p>同样的命令，去请求B.test.domain.com，则没有任何问题。</p></li>

<li><p>手机端请求异常的时候进行了抓包。发现连三次握手都没办法正常进行。</p></li>

<li><p>开始对比两个域名之间的不同地方。</p>

<ul>
<li>A域名和B域名的证书是在两个地方申请的，一个是沃通，一个是StartSSL

<ul>
<li>联系了沃通，对方技术反馈说通过<a href="https://wosign.ssllabs.com/index.html">【沃通提供的测试系统】</a>，确定我们证书没有问题。包括证书链什么的都是正常。</li>
</ul></li>
<li>A域名和B域名的证书链不一样

<ul>
<li>尝试了在沃通官网上找对应的根证书追加到A域名证书里，也是无果。</li>
</ul></li>
<li>A域名和B域名的Nginx版本不一样

<ul>
<li>A机器用了openresty，B机用了最新的nginx</li>
<li>编译参数部分不一样</li>
<li>ldd nginx，发现两台机器也是一样的。</li>
</ul></li>
<li>A域名和B域名对应的机器不一样</li>
<li>A域名和B域名长得不一样&hellip;</li>
<li>&hellip;</li>
</ul></li>

<li><p>开始思考人生</p></li>

<li><p>开始反过来测试：</p>

<ul>
<li>把A机的域名配置和证书拉到B机，重启nginx。用openssl命令连接，居然可以正常访问。排除证书问题。</li>
<li>定位到可能是A机这边的问题。

<ul>
<li>A机yum重新安装nginx：不行。</li>
<li>在A机重新编译nginx 1.4.4：不行。</li>
<li>直接把B机的nginx拉过去用：不行。</li>
</ul></li>
<li>在A机上用以前旧的nginx新开了一个1443的端口，指定A的域名。测试，可以连接。

<ul>
<li>把旧的nginx还原之前旧的配置，发现又不能连接了。</li>
<li>大神怀疑配置有问题。又开始了各种测试。</li>
<li>最终发现是“有问题”的nginx下配置了多个ssl站点。</li>
<li>把另外一些多配的ssl站点配置移走后，nginx reload后发现A站点的Https域名可以正常访问了。</li>
</ul></li>
</ul></li>

<li><p>想到之前大神处理过SVN多ssl站点的问题。但最终是因为svn客户端1.6即之后的版本都默认支持<a href="https://en.wikipedia.org/wiki/Server_Name_Indication">SNI特性</a>解决了。</p></li>

<li><p>在自己电脑上和手机上用openssl命令去连接失败，本地的Openssl版本是0.9.8的，手机的应该同样是旧版本。不支持SNI特性。openssl 1.0之后才会默认支持SNI特性。所以会连接失败。</p></li>
</ol>

<h2 id="解决方案">解决方案</h2>

<ol>
<li>手机端升级openssl，明显不太现实。</li>
<li>服务端这边只开启这一个域名为https，这样也不太现实。</li>
<li>android这边修改代码去实现。因为A证书之前在手机浏览器上访问是正常的。

<ul>
<li>有两个相关的参考地址：

<ul>
<li><a href="http://developer.android.com/training/articles/security-ssl.html">http://developer.android.com/training/articles/security-ssl.html</a></li>
<li><a href="http://blog.dev001.net/post/67082904181/android-using-sni-and-tlsv12-with-apache">http://blog.dev001.net/post/67082904181/android-using-sni-and-tlsv12-with-apache</a></li>
</ul></li>
</ul></li>
</ol>

<h2 id="后记">后记</h2>

<ol>
<li>其实一开始沃通的技术发过来的测试站点上，有列出部分终端不能支持。并且也标识低版本不支持SNI。当时没仔细从这里入手，导致这里瞎测试了一段时间。</li>
<li>配置https的域名，需要在配置配上TLSv1，目前很多旧的手机还是只支持到v1的。否则会遇到和我一样的问题。</li>
<li>希望大家不要和我踩同样的坑</li>
</ol>

  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://inorz.net/2016/04/11/zimbra%E6%B7%BB%E5%8A%A0%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91%E5%AD%97%E4%BD%93/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://inorz.net/2016/04/11/zimbra%E6%B7%BB%E5%8A%A0%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91%E5%AD%97%E4%BD%93/">zimbra添加微软雅黑字体</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://inorz.net/2016/05/22/influxdbglances%E5%92%8Cgrafana%E6%9E%84%E5%BB%BA%E7%8E%B0%E4%BB%A3%E5%8C%96%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/">InfluxDB、Glances和Grafana构建现代化监控系统</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://inorz.net/2016/05/22/influxdbglances%E5%92%8Cgrafana%E6%9E%84%E5%BB%BA%E7%8E%B0%E4%BB%A3%E5%8C%96%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'inorz-net';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="http://inorz.net/js/ui.js"></script>




</body>
</html>

